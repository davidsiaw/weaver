#!/usr/bin/exec ruby

require 'weaver'

class Website < Sinatra::Base

	set :static, true 							# set up static file routing
	set :public_folder, Gem.datadir("weaver")	# set up the static dir (with images/js/css inside)

	def getWeavefile(viewname)

		pathToFile = viewname.split("/").delete_if(&:empty?)

		viewFile = nil

		remainingPath = []

		loop do 
			path = "#{File.join(['source'] + pathToFile)}.weave"
			indexPath = File.join(["source"] + pathToFile + ["index.weave"])

			viewFile = path if File.exists?(path)
			viewFile = indexPath if File.exists?(indexPath)

			break if viewFile or pathToFile.length == 0

			remainingPath << pathToFile.last

			pathToFile = pathToFile.first pathToFile.size-1
		end 

		{ viewFile: viewFile, path: remainingPath }
	end



	get '/*' do

		if params[:splat].first.start_with? "images/"
			return send_file(params[:splat].first, :disposition => 'inline')
		end

		viewname = params[:splat].first
		result = getWeavefile viewname
		viewFile = result[:viewFile]
		path = File.join(result[:path])

		if viewFile

			site = Weaver::Weave.new(viewFile)

			if site.pages.has_key?(path)

				level = viewname.split(/\//, 0).length
				site.pages[path].generate(level)

			else
				status 404
			end
		else
			status 404
		end
	end

end

def build!
	puts "Building site..."

	buildDir = "#{Dir.pwd}/build" 
	FileUtils::rm_rf buildDir
	FileUtils.cp_r(Gem.datadir("weaver"), buildDir)
	FileUtils.cp_r("images", buildDir)

	files = Dir["source/**/*.weave"]
	files.each do |file|
		baseDir = file.chomp('.weave').chomp('index').sub(/^source\//, "")

		site = Weaver::Weave.new(file)

		site.pages.each do |localPath, page|
			resultPath = File.join(baseDir, localPath)

			level = resultPath.split(/\//, 0).length
			puts "Writing: #{file} -> #{resultPath} (Level: #{level})"

			fileName = File.join([buildDir, resultPath, "index.html"])
			FileUtils::mkdir_p File.dirname(fileName)
			File.write(fileName, page.generate(level))
		end
	end

end

def preview!
	puts "Weaver Preview Mode in: #{Dir.pwd}"

	Website.run!
end

if ARGV[0] == "build"
	build!
else
	preview!
end

exit!