#!/usr/bin/exec ruby

require 'weaver'

class PreviewApp < Sinatra::Base

	set :static, true 							# set up static file routing
	set :public_folder, Gem.datadir("weaver")	# set up the static dir (with images/js/css inside)

	def getWeavefile(viewname)

		pathToFile = viewname.split("/").delete_if(&:empty?)

		viewFile = nil

		remainingPath = []

		loop do 
			path = "#{File.join(['source'] + pathToFile)}.weave"
			indexPath = File.join(["source"] + pathToFile + ["index.weave"])

			viewFile = path if File.exists?(path)
			viewFile = indexPath if File.exists?(indexPath)

			break if viewFile or pathToFile.length == 0

			remainingPath << pathToFile.last

			pathToFile = pathToFile.first pathToFile.size-1
		end 

		{ viewFile: viewFile, path: remainingPath }
	end

	get '/*' do
		viewname = params[:splat].first
		result = getWeavefile viewname
		viewFile = result[:viewFile]
		path = File.join(result[:path])

		if viewFile
			
			site = Weaver::Site.new
			site.instance_eval File.read(viewFile), viewFile

			puts "haha '#{path}'"

			p site.pages


			if site.pages.has_key?(path)
				site.pages[path].generate(0)
			else
				status 404
			end
		else
			status 404
		end
	end

end

def build!
	puts "Building site..."
end

def preview!
	puts "Weaver Preview Mode in: #{Dir.pwd}"

	PreviewApp.run!
end

if ARGV[0] == "build"
	build!
else
	preview!
end

exit!

Weaver::preview "/Users/david/Sites/testgen" do

	center_page "", "hello" do
		h2 "Hello!"
		hr
	end

	
end